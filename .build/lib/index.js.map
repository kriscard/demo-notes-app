{
  "version": 3,
  "sources": ["../../stacks/index.js", "../../stacks/StorageStack.js", "../../stacks/ApiStack.js", "../../stacks/AuthStack.js"],
  "sourcesContent": ["import StorageStack from \"./StorageStack\";\nimport ApiStack from \"./ApiStack\";\nimport AuthStack from \"./AuthStack\";\n\nexport default function main(app) {\n  const storageStack = new StorageStack(app, \"storage\");\n\n  const apiStack = new ApiStack(app, \"api\", {\n    table: storageStack.table,\n  });\n\n  new AuthStack(app, \"auth\", {\n    api: apiStack.api,\n    bucket: storageStack.bucket,\n  });\n}\n", "import * as sst from \"@serverless-stack/resources\";\n\nexport default class StorageStack extends sst.Stack {\n  // Public reference to the table\n  table;\n\n  // Public reference to the bucket\n  bucket;\n\n  constructor(scope, id, props) {\n    super(scope, id, props);\n\n    // Create the DynamoDB table\n    this.table = new sst.Table(this, \"Notes\", {\n      fields: {\n        userId: sst.TableFieldType.STRING,\n        noteId: sst.TableFieldType.STRING,\n      },\n      primaryIndex: { partitionKey: \"userId\", sortKey: \"noteId\" },\n    });\n\n    // Create an S3 bucket\n    this.bucket = new sst.Bucket(this, \"Uploads\");\n  }\n}\n", "import * as sst from \"@serverless-stack/resources\";\n\nexport default class ApiStack extends sst.Stack {\n  // Public reference to the API\n  api;\n\n  constructor(scope, id, props) {\n    super(scope, id, props);\n\n    const { table } = props;\n\n    // Create the API\n    this.api = new sst.Api(this, \"Api\", {\n      defaultFunctionProps: {\n        environment: {\n          TABLE_NAME: table.tableName,\n          STRIPE_SECRET_KEY: process.env.STRIPE_SECRET_KEY,\n        },\n      },\n      defaultAuthorizationType: \"AWS_IAM\",\n      routes: {\n        \"POST   /notes\": \"src/create.main\",\n        \"GET    /notes/{id}\": \"src/get.main\",\n        \"GET    /notes\": \"src/list.main\",\n        \"PUT    /notes/{id}\": \"src/update.main\",\n        \"DELETE /notes/{id}\": \"src/delete.main\",\n        \"POST /billing\": \"functions/billing.main\",\n      },\n    });\n\n    // Allow the API to access the table\n    this.api.attachPermissions([table]);\n\n    // Show the API endpoint in the output\n    this.addOutputs({\n      ApiEndpoint: this.api.url,\n    });\n  }\n}\n", "import * as iam from \"aws-cdk-lib/aws-iam\";\nimport * as sst from \"@serverless-stack/resources\";\n\nexport default class AuthStack extends sst.Stack {\n  // Public reference to the auth instance\n  auth;\n\n  constructor(scope, id, props) {\n    super(scope, id, props);\n\n    const { api, bucket } = props;\n\n    // Create a Cognito User Pool and Identity Pool\n    this.auth = new sst.Auth(this, \"Auth\", {\n      cognito: {\n        userPool: {\n          // Users can login with their email and password\n          signInAliases: { email: true },\n        },\n      },\n    });\n\n    this.auth.attachPermissionsForAuthUsers([\n      // Allow access to the API\n      api,\n      // Policy granting access to a specific folder in the bucket\n      new iam.PolicyStatement({\n        actions: [\"s3:*\"],\n        effect: iam.Effect.ALLOW,\n        resources: [\n          bucket.bucketArn + \"/private/${cognito-identity.amazonaws.com:sub}/*\",\n        ],\n      }),\n    ]);\n\n    // Show the auth resources in the output\n    this.addOutputs({\n      Region: scope.region,\n      UserPoolId: this.auth.cognitoUserPool.userPoolId,\n      IdentityPoolId: this.auth.cognitoCfnIdentityPool.ref,\n      UserPoolClientId: this.auth.cognitoUserPoolClient.userPoolClientId,\n    });\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAA,UAAqB;AAErB,iCAA8C,UAAM;AAAA,EAElD;AAAA,EAGA;AAAA,EAEA,YAAY,OAAO,IAAI,OAAO;AAC5B,UAAM,OAAO,IAAI,KAAK;AAGtB,SAAK,QAAQ,IAAQ,UAAM,MAAM,SAAS;AAAA,MACxC,QAAQ;AAAA,QACN,QAAQ,AAAI,mBAAe;AAAA,QAC3B,QAAQ,AAAI,mBAAe;AAAA,MAC7B;AAAA,MACA,cAAc,EAAE,cAAc,UAAU,SAAS,SAAS;AAAA,IAC5D,CAAC;AAGD,SAAK,SAAS,IAAQ,WAAO,MAAM,SAAS;AAAA,EAC9C;AACF;AAtBA;;;ACFA,WAAqB;AAErB,6BAA0C,WAAM;AAAA,EAE9C;AAAA,EAEA,YAAY,OAAO,IAAI,OAAO;AAC5B,UAAM,OAAO,IAAI,KAAK;AAEtB,UAAM,EAAE,UAAU;AAGlB,SAAK,MAAM,IAAQ,SAAI,MAAM,OAAO;AAAA,MAClC,sBAAsB;AAAA,QACpB,aAAa;AAAA,UACX,YAAY,MAAM;AAAA,UAClB,mBAAmB,QAAQ,IAAI;AAAA,QACjC;AAAA,MACF;AAAA,MACA,0BAA0B;AAAA,MAC1B,QAAQ;AAAA,QACN,iBAAiB;AAAA,QACjB,sBAAsB;AAAA,QACtB,iBAAiB;AAAA,QACjB,sBAAsB;AAAA,QACtB,sBAAsB;AAAA,QACtB,iBAAiB;AAAA,MACnB;AAAA,IACF,CAAC;AAGD,SAAK,IAAI,kBAAkB,CAAC,KAAK,CAAC;AAGlC,SAAK,WAAW;AAAA,MACd,aAAa,KAAK,IAAI;AAAA,IACxB,CAAC;AAAA,EACH;AACF;AApCA;;;ACFA,UAAqB;AACrB,WAAqB;AAErB,8BAA2C,WAAM;AAAA,EAE/C;AAAA,EAEA,YAAY,OAAO,IAAI,OAAO;AAC5B,UAAM,OAAO,IAAI,KAAK;AAEtB,UAAM,EAAE,KAAK,WAAW;AAGxB,SAAK,OAAO,IAAQ,UAAK,MAAM,QAAQ;AAAA,MACrC,SAAS;AAAA,QACP,UAAU;AAAA,UAER,eAAe,EAAE,OAAO,KAAK;AAAA,QAC/B;AAAA,MACF;AAAA,IACF,CAAC;AAED,SAAK,KAAK,8BAA8B;AAAA,MAEtC;AAAA,MAEA,IAAQ,oBAAgB;AAAA,QACtB,SAAS,CAAC,MAAM;AAAA,QAChB,QAAQ,AAAI,WAAO;AAAA,QACnB,WAAW;AAAA,UACT,OAAO,YAAY;AAAA,QACrB;AAAA,MACF,CAAC;AAAA,IACH,CAAC;AAGD,SAAK,WAAW;AAAA,MACd,QAAQ,MAAM;AAAA,MACd,YAAY,KAAK,KAAK,gBAAgB;AAAA,MACtC,gBAAgB,KAAK,KAAK,uBAAuB;AAAA,MACjD,kBAAkB,KAAK,KAAK,sBAAsB;AAAA,IACpD,CAAC;AAAA,EACH;AACF;AAxCA;;;AHCe,cAAc,KAAK;AAChC,QAAM,eAAe,IAAI,aAAa,KAAK,SAAS;AAEpD,QAAM,WAAW,IAAI,SAAS,KAAK,OAAO;AAAA,IACxC,OAAO,aAAa;AAAA,EACtB,CAAC;AAED,MAAI,UAAU,KAAK,QAAQ;AAAA,IACzB,KAAK,SAAS;AAAA,IACd,QAAQ,aAAa;AAAA,EACvB,CAAC;AACH;AAXwB;",
  "names": []
}
